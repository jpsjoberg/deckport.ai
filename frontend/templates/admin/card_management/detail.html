{% extends "admin/base.html" %}

{% block title %}{{ card.name }} - Card Detail{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ card.name }}</h1>
            <p class="text-gray-600 mt-1">{{ card.category.title() }} • {{ card.rarity.title() }}</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="toggleEdit()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                <span id="edit-btn-text">Edit Card</span>
            </button>
            <a href="{{ url_for('admin.card_review') }}" class="text-gray-600 hover:text-gray-900">
                ← Back to Review
            </a>
        </div>
    </div>

    <!-- Card Display -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Card Art Preview -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Card Preview</h3>
            <div class="aspect-w-3 aspect-h-4 bg-gray-100 rounded-lg flex items-center justify-center">
                {% if card.has_art %}
                <img src="{{ card.art_url }}" alt="{{ card.name }}" class="max-w-full max-h-96 rounded-lg shadow-md">
                {% else %}
                <div class="text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p>No artwork generated</p>
                    <p class="text-sm">Generate via ComfyUI to see preview</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Card Details -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Card Details</h3>
            
            <!-- View Mode -->
            <div id="view-mode">
                <dl class="grid grid-cols-1 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Name</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ card.name }}</dd>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Category</dt>
                            <dd class="mt-1">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                    {{ card.category }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Rarity</dt>
                            <dd class="mt-1">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if card.rarity == 'COMMON' %}bg-gray-100 text-gray-800
                                    {% elif card.rarity == 'RARE' %}bg-blue-100 text-blue-800
                                    {% elif card.rarity == 'EPIC' %}bg-purple-100 text-purple-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ card.rarity }}
                                </span>
                            </dd>
                        </div>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Mana Color</dt>
                        <dd class="mt-1 flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: {{ mana_colors[card.color_code].color }}"></div>
                            <span class="text-sm text-gray-900">{{ mana_colors[card.color_code].name }}</span>
                        </dd>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Mana Cost</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ card.mana_cost or 0 }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Energy Cost</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ card.energy_cost or 0 }}</dd>
                        </div>
                    </div>

                    {% if card.category in ['CREATURE', 'STRUCTURE'] %}
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Attack</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ card.attack or 0 }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Defense</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ card.defense or 0 }}</dd>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Health</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ card.health or 0 }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Energy per Turn</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ card.base_energy_per_turn or 0 }}</dd>
                        </div>
                    </div>
                    {% endif %}

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Equipment Slots</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ card.equipment_slots or 0 }}</dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Targeting</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {% if card.target_friendly %}Friendly {% endif %}
                            {% if card.target_enemy %}Enemy {% endif %}
                            {% if card.target_self %}Self {% endif %}
                            {% if not (card.target_friendly or card.target_enemy or card.target_self) %}None{% endif %}
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-gray-500">Created</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ card.created_at.split('T')[0] if card.created_at else 'Unknown' }}</dd>
                    </div>
                </dl>
            </div>

            <!-- Edit Mode -->
            <div id="edit-mode" style="display: none;">
                <form method="POST" action="{{ url_for('admin.edit_card', card_id=card.id) }}" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" value="{{ card.name }}" required
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Category</label>
                            <select name="category" required
                                    class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for category in categories %}
                                <option value="{{ category }}" {% if card.category == category %}selected{% endif %}>
                                    {{ category.title() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Rarity</label>
                            <select name="rarity"
                                    class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for rarity in rarities %}
                                <option value="{{ rarity }}" {% if card.rarity == rarity %}selected{% endif %}>
                                    {{ rarity.title() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mana Color</label>
                        <select name="color_code" required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% for color, info in mana_colors.items() %}
                            <option value="{{ color }}" {% if card.color_code == color %}selected{% endif %}>
                                {{ info.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mana Cost</label>
                            <input type="number" name="mana_cost" value="{{ card.mana_cost or 0 }}" min="0" max="20"
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Energy Cost</label>
                            <input type="number" name="energy_cost" value="{{ card.energy_cost or 0 }}" min="0" max="10"
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    {% if card.category in ['CREATURE', 'STRUCTURE'] %}
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Attack</label>
                            <input type="number" name="attack" value="{{ card.attack or 0 }}" min="0" max="20"
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Defense</label>
                            <input type="number" name="defense" value="{{ card.defense or 0 }}" min="0" max="20"
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Health</label>
                            <input type="number" name="health" value="{{ card.health or 0 }}" min="0" max="50"
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Energy per Turn</label>
                            <input type="number" name="base_energy_per_turn" value="{{ card.base_energy_per_turn or 0 }}" min="0" max="10"
                                   class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    {% endif %}

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Equipment Slots</label>
                        <input type="number" name="equipment_slots" value="{{ card.equipment_slots or 0 }}" min="0" max="3"
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="toggleEdit()" 
                                class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="bg-white rounded-lg shadow-md border-l-4 border-red-500 p-6">
        <h3 class="text-lg font-semibold text-red-900 mb-4">Danger Zone</h3>
        <p class="text-sm text-red-700 mb-4">
            Permanently delete this card. This action cannot be undone.
        </p>
        <button onclick="deleteCard()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
            Delete Card
        </button>
    </div>
</div>

<script>
function toggleEdit() {
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    const editBtnText = document.getElementById('edit-btn-text');
    
    if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
        editBtnText.textContent = 'Edit Card';
    } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
        editBtnText.textContent = 'Cancel Edit';
    }
}

function deleteCard() {
    if (confirm('Are you sure you want to delete "{{ card.name }}"? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin.delete_card", card_id=card.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
