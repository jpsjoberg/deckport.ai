{% extends "admin/base.html" %}

{% block title %}Generate Card Graphics - Deckport Admin{% endblock %}
{% block page_title %}Generate Graphics for Existing Cards{% endblock %}
{% block page_subtitle %}Batch generate artwork and videos for your {{ total_cards }} cards{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Card Statistics Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <i class="fas fa-layer-group text-3xl text-blue-500 mr-4"></i>
                <div>
                    <p class="text-sm text-gray-500">Total Cards</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_cards }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <i class="fas fa-image text-3xl text-green-500 mr-4"></i>
                <div>
                    <p class="text-sm text-gray-500">With Graphics</p>
                    <p class="text-2xl font-bold text-gray-900">{{ cards_with_graphics }}</p>
                    <p class="text-xs text-gray-400">{{ completion_percent }}%</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-3xl text-red-500 mr-4"></i>
                <div>
                    <p class="text-sm text-gray-500">Need Graphics</p>
                    <p class="text-2xl font-bold text-gray-900">{{ cards_without_graphics }}</p>
                    <p class="text-xs text-gray-400">{{ 100 - completion_percent }}%</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <i class="fas fa-server text-3xl text-purple-500 mr-4"></i>
                <div>
                    <p class="text-sm text-gray-500">External Storage</p>
                    <p class="text-lg font-bold text-gray-900">10GB Available</p>
                    <p class="text-xs text-gray-400">Ready for assets</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphics Generation Controls -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">
            <i class="fas fa-magic mr-2 text-purple-500"></i>
            Generate Graphics for Existing Cards
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Batch Generation Options -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">Batch Generation Options</h3>
                <form id="batchGenerationForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Generation Type</label>
                        <select name="generation_type" class="w-full rounded-md border-gray-300 shadow-sm">
                            <option value="artwork">Artwork Only (Images)</option>
                            <option value="videos">Videos Only (Animations)</option>
                            <option value="both" selected>Both Artwork & Videos</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Batch Size</label>
                        <select name="batch_size" class="w-full rounded-md border-gray-300 shadow-sm">
                            <option value="10" selected>10 cards (Recommended)</option>
                            <option value="25">25 cards</option>
                            <option value="50">50 cards</option>
                            <option value="100">100 cards (Slow)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Smaller batches are more reliable</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select name="priority" class="w-full rounded-md border-gray-300 shadow-sm">
                            <option value="normal" selected>Normal Priority</option>
                            <option value="high">High Priority</option>
                        </select>
                    </div>

                    <button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 transition-colors font-medium">
                        <i class="fas fa-play mr-2"></i>Start Batch Generation
                    </button>
                </form>
            </div>

            <!-- Quick Actions -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-4">
                    <button onclick="generateAllMissing()" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors font-medium">
                        <i class="fas fa-magic mr-2"></i>Generate ALL Missing Graphics
                        <span class="block text-sm font-normal opacity-90">Process all {{ cards_without_graphics }} cards without graphics</span>
                    </button>

                    <button onclick="generateArtworkOnly()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                        <i class="fas fa-image mr-2"></i>Generate Artwork Only
                        <span class="block text-sm font-normal opacity-90">Just static card images (faster)</span>
                    </button>

                    <button onclick="generateVideosOnly()" class="w-full bg-orange-600 text-white py-3 px-4 rounded-md hover:bg-orange-700 transition-colors font-medium">
                        <i class="fas fa-video mr-2"></i>Generate Videos Only
                        <span class="block text-sm font-normal opacity-90">Animated card backgrounds</span>
                    </button>

                    <a href="/admin/assets/generation" class="block w-full bg-gray-600 text-white py-3 px-4 rounded-md hover:bg-gray-700 transition-colors font-medium text-center">
                        <i class="fas fa-chart-line mr-2"></i>View Generation Queue
                        <span class="block text-sm font-normal opacity-90">Monitor progress and manage jobs</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Information -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <div class="flex">
            <i class="fas fa-info-circle text-blue-400 mt-1"></i>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Graphics Generation Process</h3>
                <div class="text-sm text-blue-700 mt-2">
                    <p><strong>Step 1:</strong> Generate artwork using ComfyUI (2-3 minutes per card)</p>
                    <p><strong>Step 2:</strong> Generate animated video backgrounds (3-4 minutes per card)</p>
                    <p><strong>Step 3:</strong> Compose final card with frame and stats</p>
                    <p><strong>Storage:</strong> All assets stored on external 10GB drive</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ComfyUI Status Check -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-server mr-2 text-indigo-500"></i>
            ComfyUI Server Status
        </h3>
        <div id="comfyui-status" class="text-center py-4">
            <button onclick="checkComfyUI()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                <i class="fas fa-sync mr-2"></i>Check ComfyUI Status
            </button>
        </div>
    </div>
</div>

<script>
// Generate all missing graphics
async function generateAllMissing() {
    if (!confirm(`Generate graphics for all {{ cards_without_graphics }} cards without artwork? This will take several hours.`)) {
        return;
    }
    
    try {
        const response = await fetch('/v1/admin/card-sets/assets/batch-generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                generation_type: 'both',
                batch_size: 10,
                priority: 'normal'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Started generating graphics for ${result.total_cards} cards! Check the generation queue for progress.`);
            window.location.href = '/admin/assets/generation';
        } else {
            alert(`Failed to start generation: ${result.error}`);
        }
    } catch (error) {
        alert('Error starting batch generation');
    }
}

// Generate artwork only
async function generateArtworkOnly() {
    if (!confirm('Generate artwork (images) for cards without graphics?')) {
        return;
    }
    
    try {
        const response = await fetch('/v1/admin/card-sets/assets/batch-generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                generation_type: 'artwork',
                batch_size: 25,
                priority: 'normal'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Started generating artwork for ${result.total_cards} cards!`);
            window.location.href = '/admin/assets/generation';
        } else {
            alert(`Failed to start generation: ${result.error}`);
        }
    } catch (error) {
        alert('Error starting artwork generation');
    }
}

// Generate videos only
async function generateVideosOnly() {
    if (!confirm('Generate animated videos for cards with artwork?')) {
        return;
    }
    
    try {
        const response = await fetch('/v1/admin/card-sets/assets/batch-generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                generation_type: 'videos',
                batch_size: 15,
                priority: 'normal'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Started generating videos for ${result.total_cards} cards!`);
            window.location.href = '/admin/assets/generation';
        } else {
            alert(`Failed to start generation: ${result.error}`);
        }
    } catch (error) {
        alert('Error starting video generation');
    }
}

// Check ComfyUI status
async function checkComfyUI() {
    try {
        const response = await fetch('/admin/assets/comfyui/status');
        const result = await response.json();
        
        const statusDiv = document.getElementById('comfyui-status');
        
        if (result.status === 'online') {
            statusDiv.innerHTML = `
                <div class="text-green-600">
                    <i class="fas fa-check-circle text-2xl mb-2"></i>
                    <p class="font-medium">ComfyUI Online</p>
                    <p class="text-sm">Ready for graphics generation</p>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="text-red-600">
                    <i class="fas fa-times-circle text-2xl mb-2"></i>
                    <p class="font-medium">ComfyUI Offline</p>
                    <p class="text-sm">Graphics generation not available</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('comfyui-status').innerHTML = `
            <div class="text-yellow-600">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p class="font-medium">Status Unknown</p>
                <p class="text-sm">Could not check ComfyUI status</p>
            </div>
        `;
    }
}

// Batch generation form
document.getElementById('batchGenerationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        generation_type: formData.get('generation_type'),
        batch_size: parseInt(formData.get('batch_size')),
        priority: formData.get('priority')
    };
    
    if (!confirm(`Start batch generation of ${data.batch_size} cards?`)) {
        return;
    }
    
    try {
        const response = await fetch('/v1/admin/card-sets/assets/batch-generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Batch generation started! Processing ${result.total_cards} cards.`);
            window.location.href = '/admin/assets/generation';
        } else {
            alert(`Failed to start generation: ${result.error}`);
        }
    } catch (error) {
        alert('Error starting batch generation');
    }
});

// Auto-check ComfyUI status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkComfyUI();
});
</script>
{% endblock %}
