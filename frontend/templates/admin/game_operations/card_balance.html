{% extends "admin/base.html" %}

{% block title %}Card Balance Management - Deckport Admin{% endblock %}
{% block page_title %}Card Balance Management{% endblock %}
{% block page_subtitle %}Dynamic card balancing and meta analysis{% endblock %}

{% block content %}
<!-- Balance Overview Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-balance-scale text-2xl text-blue-400"></i>
            </div>
            <div class="ml-4 flex-1">
                <h3 class="text-lg font-semibold text-white">Total Cards</h3>
                <div class="flex items-baseline">
                    <span class="text-3xl font-bold text-blue-400">347</span>
                </div>
                <p class="text-sm text-gray-400">Across all sets</p>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
            </div>
            <div class="ml-4 flex-1">
                <h3 class="text-lg font-semibold text-white">Imbalanced</h3>
                <div class="flex items-baseline">
                    <span class="text-3xl font-bold text-red-400">7</span>
                </div>
                <p class="text-sm text-gray-400">Need attention</p>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-chart-line text-2xl text-green-400"></i>
            </div>
            <div class="ml-4 flex-1">
                <h3 class="text-lg font-semibold text-white">Meta Diversity</h3>
                <div class="flex items-baseline">
                    <span class="text-3xl font-bold text-green-400">73%</span>
                </div>
                <p class="text-sm text-gray-400">Healthy variety</p>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-clock text-2xl text-yellow-400"></i>
            </div>
            <div class="ml-4 flex-1">
                <h3 class="text-lg font-semibold text-white">Last Balance</h3>
                <div class="flex items-baseline">
                    <span class="text-3xl font-bold text-yellow-400">3</span>
                </div>
                <p class="text-sm text-gray-400">Days ago</p>
            </div>
        </div>
    </div>
</div>

<!-- Card Balance Dashboard -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Problem Cards List -->
    <div class="lg:col-span-2 bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-white">Cards Requiring Balance Attention</h3>
            <div class="flex space-x-2">
                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh Data
                </button>
                <button class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm" onclick="bulkBalanceMode()">
                    <i class="fas fa-edit mr-1"></i> Bulk Edit
                </button>
            </div>
        </div>

        <!-- Problem Cards Table -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Card</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Win Rate</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Usage</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Issue</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    <tr class="hover:bg-gray-700">
                        <td class="px-4 py-4">
                            <div class="flex items-center">
                                <img src="/static/images/cards/crimson_dragon.jpg" alt="Crimson Dragon" class="w-10 h-14 rounded mr-3 object-cover">
                                <div>
                                    <div class="text-sm font-medium text-white">Crimson Dragon</div>
                                    <div class="text-sm text-gray-400">Epic • Fire</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-900 text-red-300">
                                67.3%
                            </span>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-300">
                            89.2%
                        </td>
                        <td class="px-4 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-900 text-red-300">
                                Overpowered
                            </span>
                        </td>
                        <td class="px-4 py-4">
                            <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm mr-2" onclick="editCard('crimson_dragon')">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </button>
                            <button class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm" onclick="viewCardAnalytics('crimson_dragon')">
                                <i class="fas fa-chart-bar mr-1"></i> Analytics
                            </button>
                        </td>
                    </tr>
                    
                    <tr class="hover:bg-gray-700">
                        <td class="px-4 py-4">
                            <div class="flex items-center">
                                <img src="/static/images/cards/healing_potion.jpg" alt="Healing Potion" class="w-10 h-14 rounded mr-3 object-cover">
                                <div>
                                    <div class="text-sm font-medium text-white">Healing Potion</div>
                                    <div class="text-sm text-gray-400">Common • Support</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900 text-blue-300">
                                23.1%
                            </span>
                        </td>
                        <td class="px-4 py-4 text-sm text-gray-300">
                            4.7%
                        </td>
                        <td class="px-4 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900 text-blue-300">
                                Underpowered
                            </span>
                        </td>
                        <td class="px-4 py-4">
                            <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm mr-2" onclick="editCard('healing_potion')">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </button>
                            <button class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm" onclick="viewCardAnalytics('healing_potion')">
                                <i class="fas fa-chart-bar mr-1"></i> Analytics
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Balance Actions -->
    <div class="space-y-6">
        <!-- Balance Presets -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-semibold text-white mb-4">Quick Balance Actions</h3>
            <div class="space-y-3">
                <button class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded font-medium text-sm" onclick="emergencyNerf()">
                    <i class="fas fa-arrow-down mr-2"></i>
                    Emergency Nerf
                </button>
                <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-medium text-sm" onclick="minorBuff()">
                    <i class="fas fa-arrow-up mr-2"></i>
                    Minor Buff
                </button>
                <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium text-sm" onclick="costAdjustment()">
                    <i class="fas fa-coins mr-2"></i>
                    Cost Adjustment
                </button>
                <button class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded font-medium text-sm" onclick="abilityTweak()">
                    <i class="fas fa-magic mr-2"></i>
                    Ability Tweak
                </button>
            </div>
        </div>

        <!-- Balance History -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-semibold text-white mb-4">Recent Balance Changes</h3>
            <div class="space-y-3">
                <div class="p-3 bg-gray-700 rounded">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-white">Lightning Bolt</span>
                        <span class="text-xs text-gray-400">2 hours ago</span>
                    </div>
                    <div class="text-xs text-gray-400">
                        Damage: 4 → 3 (-25%)
                    </div>
                </div>
                
                <div class="p-3 bg-gray-700 rounded">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-white">Shield Wall</span>
                        <span class="text-xs text-gray-400">1 day ago</span>
                    </div>
                    <div class="text-xs text-gray-400">
                        Defense: 2 → 3 (+50%)
                    </div>
                </div>
                
                <div class="p-3 bg-gray-700 rounded">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-white">Mana Crystal</span>
                        <span class="text-xs text-gray-400">3 days ago</span>
                    </div>
                    <div class="text-xs text-gray-400">
                        Cost: 2 → 1 (-50%)
                    </div>
                </div>
            </div>
            <div class="block mt-3 text-center text-gray-500 text-sm">
                Full History (Coming Soon)
            </div>
        </div>
    </div>
</div>

<!-- Meta Analysis Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Win Rate Distribution -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Win Rate Distribution</h3>
        <canvas id="winRateChart" width="400" height="300"></canvas>
    </div>

    <!-- Card Usage Trends -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Card Usage Trends (7 Days)</h3>
        <canvas id="usageTrendsChart" width="400" height="300"></canvas>
    </div>
</div>

<!-- Card Editor Modal -->
<div id="cardEditorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-white">Card Balance Editor</h3>
            <button class="text-gray-400 hover:text-white" onclick="closeCardEditor()">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="cardEditorContent">
            <!-- Dynamic card editor content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='admin/js/card-balance.js') }}"></script>
<script>
// Initialize card balance management
document.addEventListener('DOMContentLoaded', function() {
    initializeCardBalance();
    loadBalanceCharts();
});

// Card editing functions
function editCard(cardId) {
    // Load card editor modal
    fetch(`/admin/api/cards/${cardId}/editor`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('cardEditorContent').innerHTML = html;
            document.getElementById('cardEditorModal').classList.remove('hidden');
        });
}

function closeCardEditor() {
    document.getElementById('cardEditorModal').classList.add('hidden');
}

function viewCardAnalytics(cardId) {
    // Open card analytics in new tab
    window.open(`/admin/analytics/card/${cardId}`, '_blank');
}

// Quick balance actions
function emergencyNerf() {
    if (confirm('Apply emergency nerf to selected cards? This will immediately reduce their power level by 15-25%.')) {
        // Apply emergency nerf
        showAlert('Emergency nerf applied to selected cards', 'success');
    }
}

function minorBuff() {
    if (confirm('Apply minor buff to selected cards? This will increase their power level by 5-10%.')) {
        // Apply minor buff
        showAlert('Minor buff applied to selected cards', 'success');
    }
}

function costAdjustment() {
    // Open cost adjustment dialog
    const newCost = prompt('Enter new mana cost:');
    if (newCost !== null) {
        showAlert(`Cost adjusted to ${newCost} mana`, 'success');
    }
}

function abilityTweak() {
    // Open ability editor
    showAlert('Ability editor opened', 'info');
}

function bulkBalanceMode() {
    // Toggle bulk balance mode
    showAlert('Bulk balance mode activated', 'info');
}
</script>
{% endblock %}
