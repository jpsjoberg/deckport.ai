{% extends "admin/base.html" %}

{% block title %}Game Analytics - Deckport Admin{% endblock %}
{% block page_title %}Game Analytics{% endblock %}
{% block page_subtitle %}Player behavior, match statistics, and performance insights{% endblock %}

{% block content %}
<!-- Analytics Overview -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Total Players</h3>
                <span class="text-3xl font-bold text-blue-400">{{ analytics.total_players or 0 }}</span>
            </div>
            <i class="fas fa-users text-2xl text-blue-400"></i>
        </div>
        <div class="mt-2 text-sm text-gray-400">
            {{ analytics.new_players or 0 }} new this week
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Active Players</h3>
                <span class="text-3xl font-bold text-green-400">{{ analytics.active_players or 0 }}</span>
            </div>
            <i class="fas fa-user-check text-2xl text-green-400"></i>
        </div>
        <div class="mt-2 text-sm text-gray-400">
            {{ "%.1f"|format(analytics.retention_rate or 0) }}% retention rate
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Avg Session</h3>
                <span class="text-3xl font-bold text-purple-400">{{ analytics.avg_session_duration or 0 }}m</span>
            </div>
            <i class="fas fa-clock text-2xl text-purple-400"></i>
        </div>
        <div class="mt-2 text-sm text-gray-400">
            Per player session
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Peak Concurrent</h3>
                <span class="text-3xl font-bold text-yellow-400">{{ analytics.peak_concurrent or 0 }}</span>
            </div>
            <i class="fas fa-chart-line text-2xl text-yellow-400"></i>
        </div>
        <div class="mt-2 text-sm text-gray-400">
            Today's peak
        </div>
    </div>
</div>

<!-- Analytics Dashboard -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Player Activity Chart -->
    <div class="lg:col-span-2 bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-white">Player Activity Trends</h3>
            <div class="flex space-x-2">
                <select id="activityPeriod" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm text-white">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d" selected>Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm" onclick="refreshActivityChart()">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                </button>
            </div>
        </div>
        <canvas id="activityChart" width="400" height="200"></canvas>
    </div>
    
    <!-- Top Players -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Top Players</h3>
        {% if analytics.top_players %}
        <div class="space-y-3">
            {% for player in analytics.top_players[:10] %}
            <div class="flex items-center justify-between p-2 bg-gray-700 rounded">
                <div class="flex items-center">
                    <span class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-3">
                        {{ player.rank }}
                    </span>
                    <div>
                        <div class="text-sm font-medium text-white">{{ player.display_name }}</div>
                        <div class="text-xs text-gray-400">{{ player.matches_played }} matches</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-medium text-white">{{ player.rating }}</div>
                    <div class="text-xs text-gray-400">{{ "%.1f"|format(player.win_rate) }}% WR</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-gray-400 py-8">
            <i class="fas fa-user-friends text-4xl mb-4"></i>
            <p>No player data available</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Detailed Analytics -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Match Statistics -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Match Statistics</h3>
        <canvas id="matchStatsChart" width="400" height="300"></canvas>
    </div>
    
    <!-- Hourly Distribution -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Player Activity by Hour</h3>
        <canvas id="hourlyChart" width="400" height="300"></canvas>
    </div>
</div>

<!-- Performance Metrics -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Game Performance -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Game Performance</h3>
        <div class="space-y-4">
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-400">Avg Match Duration</span>
                    <span class="text-white">{{ analytics.avg_match_duration or 0 }}m</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (analytics.avg_match_duration or 0) / 60 * 100 }}%"></div>
                </div>
            </div>
            
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-400">Match Completion Rate</span>
                    <span class="text-white">{{ "%.1f"|format(analytics.completion_rate or 0) }}%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-green-600 h-2 rounded-full" style="width: {{ analytics.completion_rate or 0 }}%"></div>
                </div>
            </div>
            
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-400">Queue Wait Time</span>
                    <span class="text-white">{{ analytics.avg_queue_time or 0 }}s</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-yellow-600 h-2 rounded-full" style="width: {{ (analytics.avg_queue_time or 0) / 120 * 100 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Player Engagement -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Player Engagement</h3>
        <div class="space-y-4">
            <div class="flex justify-between">
                <span class="text-gray-400">Daily Active Users</span>
                <span class="text-white font-medium">{{ analytics.daily_active or 0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Weekly Active Users</span>
                <span class="text-white font-medium">{{ analytics.weekly_active or 0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Monthly Active Users</span>
                <span class="text-white font-medium">{{ analytics.monthly_active or 0 }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Avg Sessions per User</span>
                <span class="text-white font-medium">{{ "%.1f"|format(analytics.avg_sessions_per_user or 0) }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Churn Rate</span>
                <span class="text-white font-medium">{{ "%.1f"|format(analytics.churn_rate or 0) }}%</span>
            </div>
        </div>
    </div>
    
    <!-- System Health -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">System Health</h3>
        <div class="space-y-4">
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-400">Server Uptime</span>
                    <span class="text-white">99.9%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-green-600 h-2 rounded-full" style="width: 99.9%"></div>
                </div>
            </div>
            
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-400">API Response Time</span>
                    <span class="text-white">45ms</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: 75%"></div>
                </div>
            </div>
            
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-400">Error Rate</span>
                    <span class="text-white">0.1%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-red-600 h-2 rounded-full" style="width: 1%"></div>
                </div>
            </div>
            
            <div class="pt-2 border-t border-gray-700">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Active Connections</span>
                    <span class="text-white">{{ analytics.active_connections or 0 }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-400">Database Queries/sec</span>
                    <span class="text-white">{{ analytics.db_queries_per_sec or 0 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeActivityChart();
    initializeMatchStatsChart();
    initializeHourlyChart();
});

// Player Activity Chart
function initializeActivityChart() {
    const ctx = document.getElementById('activityChart').getContext('2d');
    
    // Generate mock data based on analytics
    const labels = [];
    const data = [];
    
    {% if analytics.daily_activity %}
    {% for day in analytics.daily_activity %}
    labels.push('{{ day.date }}');
    data.push({{ day.active_players }});
    {% endfor %}
    {% else %}
    // Generate mock data for 7 days
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString());
        data.push(Math.floor(Math.random() * 100) + 50);
    }
    {% endif %}
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Active Players',
                data: data,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {color: 'white'}
                }
            },
            scales: {
                x: {
                    ticks: {color: 'white'},
                    grid: {color: 'rgba(255, 255, 255, 0.1)'}
                },
                y: {
                    ticks: {color: 'white'},
                    grid: {color: 'rgba(255, 255, 255, 0.1)'}
                }
            }
        }
    });
}

// Match Statistics Chart
function initializeMatchStatsChart() {
    const ctx = document.getElementById('matchStatsChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['1v1 Matches', 'Tournament', 'Casual', 'Practice'],
            datasets: [{
                data: [65, 20, 10, 5],
                backgroundColor: [
                    'rgb(59, 130, 246)',
                    'rgb(168, 85, 247)',
                    'rgb(34, 197, 94)',
                    'rgb(251, 191, 36)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {color: 'white'},
                    position: 'bottom'
                }
            }
        }
    });
}

// Hourly Distribution Chart
function initializeHourlyChart() {
    const ctx = document.getElementById('hourlyChart').getContext('2d');
    
    const hourlyData = [];
    {% if analytics.hourly_distribution %}
    {% for hour_data in analytics.hourly_distribution %}
    hourlyData.push({{ hour_data.active_players }});
    {% endfor %}
    {% else %}
    // Generate mock hourly data
    for (let i = 0; i < 24; i++) {
        // Simulate higher activity during peak hours (evening)
        let baseActivity = 20;
        if (i >= 18 && i <= 23) baseActivity = 80;
        else if (i >= 12 && i <= 17) baseActivity = 60;
        else if (i >= 6 && i <= 11) baseActivity = 40;
        
        hourlyData.push(baseActivity + Math.floor(Math.random() * 20));
    }
    {% endif %}
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Active Players',
                data: hourlyData,
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {color: 'white'}
                }
            },
            scales: {
                x: {
                    ticks: {color: 'white'},
                    grid: {color: 'rgba(255, 255, 255, 0.1)'}
                },
                y: {
                    ticks: {color: 'white'},
                    grid: {color: 'rgba(255, 255, 255, 0.1)'}
                }
            }
        }
    });
}

// Refresh functions
function refreshActivityChart() {
    showAlert('Refreshing activity data...', 'info');
    // In a real implementation, this would fetch new data and update the chart
    setTimeout(() => {
        showAlert('Activity data refreshed', 'success');
    }, 1000);
}

// Period change handler
document.getElementById('activityPeriod').addEventListener('change', function() {
    const period = this.value;
    showAlert(`Switching to ${period} view...`, 'info');
    // In a real implementation, this would fetch data for the selected period
});

// Real-time updates
setInterval(() => {
    // Update real-time metrics
    updateRealTimeMetrics();
}, 30000); // Update every 30 seconds

function updateRealTimeMetrics() {
    // In a real implementation, this would fetch current metrics
    console.log('Updating real-time metrics...');
}

// Alert system
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-600 text-white' :
        type === 'error' ? 'bg-red-600 text-white' :
        type === 'warning' ? 'bg-yellow-600 text-black' :
        'bg-blue-600 text-white'
    }`;
    alertDiv.textContent = message;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
