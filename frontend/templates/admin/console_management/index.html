{% extends "admin/base.html" %}

{% block title %}Console Fleet Management - Deckport Admin{% endblock %}
{% block page_title %}Console Fleet Management{% endblock %}
{% block page_subtitle %}Monitor and manage all console devices{% endblock %}

{% block content %}
<!-- Console Fleet Overview -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
    <!-- Fleet Statistics -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Total Consoles</h3>
                <span class="text-3xl font-bold text-blue-400">{{ fleet_stats.total }}</span>
            </div>
            <i class="fas fa-desktop text-2xl text-blue-400"></i>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Online</h3>
                <span class="text-3xl font-bold text-green-400">{{ fleet_stats.online }}</span>
            </div>
            <i class="fas fa-circle text-2xl text-green-400"></i>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Offline</h3>
                <span class="text-3xl font-bold text-red-400">{{ fleet_stats.offline }}</span>
            </div>
            <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-white">Pending</h3>
                <span class="text-3xl font-bold text-yellow-400">{{ fleet_stats.pending }}</span>
            </div>
            <i class="fas fa-clock text-2xl text-yellow-400"></i>
        </div>
    </div>
</div>

<!-- Console Map and Controls -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Interactive Console Map -->
    <div class="lg:col-span-2 bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Console Locations</h3>
            <div class="flex space-x-2">
                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                </button>
                <button class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i> Add Console
                </button>
            </div>
        </div>
        
        <!-- Placeholder for interactive map -->
        <div class="h-96 bg-gray-700 rounded-lg flex items-center justify-center">
            <div class="text-center">
                <i class="fas fa-map-marked-alt text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-400">Interactive Console Map</p>
                <p class="text-sm text-gray-400">Real-time console status visualization</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="space-y-6">
        <!-- Bulk Actions -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-semibold text-white mb-4">Bulk Actions</h3>
            <div class="space-y-3">
                <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium text-sm">
                    <i class="fas fa-broadcast-tower mr-2"></i>
                    Broadcast to All
                </button>
                <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-medium text-sm">
                    <i class="fas fa-download mr-2"></i>
                    Push Update
                </button>
                <button class="w-full px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded font-medium text-sm">
                    <i class="fas fa-pause mr-2"></i>
                    Maintenance Mode
                </button>
                <button class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded font-medium text-sm">
                    <i class="fas fa-power-off mr-2"></i>
                    Emergency Shutdown
                </button>
            </div>
        </div>

        <!-- Registration Queue -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Pending Registrations</h3>
                <span class="px-2 py-1 bg-orange-600 text-xs font-medium rounded">{{ fleet_stats.pending }}</span>
            </div>
            <div class="space-y-2">
                {% for console in pending_consoles %}
                <div class="p-2 bg-gray-700 rounded text-sm">
                    <div class="flex items-center justify-between">
                        <span>{{ console.device_uid }}</span>
                        <div class="flex space-x-1">
                            <button class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs" 
                                    onclick="approveConsole('{{ console.device_uid }}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs"
                                    onclick="rejectConsole('{{ console.device_uid }}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-gray-400 py-4">
                    <i class="fas fa-check-circle text-2xl mb-2"></i>
                    <p>No pending registrations</p>
                </div>
                {% endfor %}
            </div>
            <a href="{{ url_for('admin.console_registration') }}" class="block mt-3 text-center text-blue-400 hover:text-blue-300 text-sm">
                View All Pending â†’
            </a>
        </div>
    </div>
</div>

<!-- Console List Table -->
<div class="bg-gray-800 rounded-lg border border-gray-700">
    <div class="p-6 border-b border-gray-700">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white">Console Fleet</h3>
            <div class="flex items-center space-x-4">
                <!-- Search -->
                <div class="relative">
                    <input type="text" placeholder="Search consoles..." class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white w-64 focus:outline-none focus:border-blue-500">
                    <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                </div>
                
                <!-- Filters -->
                <select class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                    <option>All Status</option>
                    <option>Online</option>
                    <option>Offline</option>
                    <option>Maintenance</option>
                </select>
                
                <select class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                    <option>All Locations</option>
                    <option>New York</option>
                    <option>Los Angeles</option>
                    <option>Chicago</option>
                    <option>San Francisco</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                        <input type="checkbox" class="rounded border-gray-600 bg-gray-700">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Console ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Location</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Current Player</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Uptime</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Last Seen</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for console in consoles %}
                <tr class="hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded border-gray-600 bg-gray-700" value="{{ console.device_uid }}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <i class="fas fa-desktop text-blue-400 mr-3"></i>
                            <div>
                                <div class="text-sm font-medium text-white">{{ console.device_uid }}</div>
                                <div class="text-sm text-gray-400">RSA: {{ console.public_key_fingerprint or '****' }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if console.is_online %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900 text-green-300">
                            <div class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></div>
                            Online
                        </span>
                        {% elif console.status == 'active' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-900 text-red-300">
                            <div class="w-1.5 h-1.5 bg-red-400 rounded-full mr-1.5"></div>
                            Offline
                        </span>
                        {% elif console.status == 'pending' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-900 text-yellow-300">
                            <div class="w-1.5 h-1.5 bg-yellow-400 rounded-full mr-1.5"></div>
                            Pending
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-900 text-gray-300">
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-1.5"></div>
                            {{ console.status.title() }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {{ console.location or 'Unknown' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {{ console.current_player or '-' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {{ "%.1f"|format(console.uptime_7d) }}% (7d)
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {% if console.last_seen_minutes is not none %}
                            {% if console.last_seen_minutes < 60 %}
                                {{ console.last_seen_minutes }} min ago
                            {% elif console.last_seen_minutes < 1440 %}
                                {{ (console.last_seen_minutes / 60)|int }} hours ago
                            {% else %}
                                {{ (console.last_seen_minutes / 1440)|int }} days ago
                            {% endif %}
                        {% else %}
                            Never
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <a href="{{ url_for('admin.console_detail', device_uid=console.device_uid) }}" class="text-blue-400 hover:text-blue-300" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if console.is_online %}
                            <button class="text-yellow-400 hover:text-yellow-300" onclick="remoteControl('{{ console.device_uid }}')" title="Remote Control">
                                <i class="fas fa-mouse-pointer"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300" onclick="rebootConsole('{{ console.device_uid }}')" title="Reboot">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="shutdownConsole('{{ console.device_uid }}')" title="Shutdown">
                                <i class="fas fa-power-off"></i>
                            </button>
                            {% else %}
                            <button class="text-gray-400 cursor-not-allowed" disabled title="Remote Control (Offline)">
                                <i class="fas fa-mouse-pointer"></i>
                            </button>
                            <button class="text-gray-400 cursor-not-allowed" disabled title="Reboot (Offline)">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="text-orange-400 hover:text-orange-300" onclick="pingConsole('{{ console.device_uid }}')" title="Ping">
                                <i class="fas fa-wifi"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-400">
                        <i class="fas fa-desktop text-4xl mb-4"></i>
                        <p class="text-lg">No consoles registered</p>
                        <p class="text-sm">Consoles will appear here once they register with the system</p>
                        <!-- DEBUG: consoles={{ consoles|length }}, type={{ consoles.__class__.__name__ }} -->
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="px-6 py-3 border-t border-gray-700">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-400">
                Showing 1 to 10 of 50 consoles
            </div>
            <div class="flex items-center space-x-2">
                <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">Previous</button>
                <button class="px-3 py-1 bg-blue-600 rounded text-sm">1</button>
                <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">2</button>
                <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">3</button>
                <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">Next</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='admin/js/console-management.js') }}"></script>
<script>
// Initialize console management
document.addEventListener('DOMContentLoaded', function() {
    initializeConsoleManagement();
    startRealTimeConsoleUpdates();
});

// Console action functions
function remoteControl(consoleId) {
    // Open remote control interface
    window.open(`/admin/console/${consoleId}/remote`, '_blank');
}

function rebootConsole(consoleId) {
    if (confirm(`Are you sure you want to reboot console ${consoleId}?`)) {
        // Send reboot command
        fetch(`/admin/api/console/${consoleId}/reboot`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.success ? 'success' : 'error');
            });
    }
}

function shutdownConsole(consoleId) {
    if (confirm(`Are you sure you want to shutdown console ${consoleId}?`)) {
        // Send shutdown command
        fetch(`/admin/api/console/${consoleId}/shutdown`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.success ? 'success' : 'error');
            });
    }
}

function pingConsole(consoleId) {
    // Send ping to offline console
    fetch(`/admin/api/console/${consoleId}/ping`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            showAlert(data.message, data.success ? 'success' : 'error');
        });
}

function approveConsole(deviceUid) {
    if (confirm(`Are you sure you want to approve console ${deviceUid}?`)) {
        fetch(`/admin/api/console/${deviceUid}/approve`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    // Refresh the page to update the UI
                    setTimeout(() => location.reload(), 1500);
                }
            });
    }
}

function rejectConsole(deviceUid) {
    if (confirm(`Are you sure you want to reject console ${deviceUid}?`)) {
        fetch(`/admin/api/console/${deviceUid}/reject`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                showAlert(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    // Refresh the page to update the UI
                    setTimeout(() => location.reload(), 1500);
                }
            });
    }
}

// Real-time updates
function startRealTimeConsoleUpdates() {
    setInterval(() => {
        fetch('/admin/api/consoles/fleet-status')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    // Update fleet statistics
                    document.querySelector('.text-blue-400').textContent = data.total;
                    document.querySelector('.text-green-400').textContent = data.online;
                    document.querySelector('.text-red-400').textContent = data.offline;
                    document.querySelector('.text-yellow-400').textContent = data.maintenance;
                }
            })
            .catch(error => console.log('Fleet status update failed:', error));
    }, 30000); // Update every 30 seconds
}

// Alert system
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-600 text-white' :
        type === 'error' ? 'bg-red-600 text-white' :
        type === 'warning' ? 'bg-yellow-600 text-black' :
        'bg-blue-600 text-white'
    }`;
    alertDiv.textContent = message;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
