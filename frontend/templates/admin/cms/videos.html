{% extends "admin/base.html" %}

{% block title %}Videos Management - Deckport Admin{% endblock %}
{% block page_title %}Videos Management{% endblock %}
{% block page_subtitle %}Create and manage video content and media{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="flex justify-between items-center mb-8">
    <div class="flex items-center space-x-4">
        <a href="{{ url_for('admin.cms_dashboard') }}" class="text-gray-400 hover:text-white">
            <i class="fas fa-arrow-left mr-2"></i>Back to CMS
        </a>
        
        <!-- Filters -->
        <div class="flex items-center space-x-3">
            <select id="status-filter" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 text-sm">
                <option value="">All Status</option>
                <option value="published">Published</option>
                <option value="draft">Draft</option>
                <option value="archived">Archived</option>
            </select>
            
            <select id="type-filter" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 text-sm">
                <option value="">All Types</option>
                <option value="tutorial">Tutorial</option>
                <option value="gameplay">Gameplay</option>
                <option value="card_reveal">Card Reveal</option>
                <option value="tournament">Tournament</option>
                <option value="developer">Developer</option>
                <option value="community">Community</option>
            </select>
            
            <select id="platform-filter" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 text-sm">
                <option value="">All Platforms</option>
                <option value="youtube">YouTube</option>
                <option value="vimeo">Vimeo</option>
                <option value="twitch">Twitch</option>
                <option value="direct">Direct Upload</option>
            </select>
            
            <input type="text" id="search-input" placeholder="Search videos..." 
                   class="bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 text-sm w-64">
        </div>
    </div>
    
    <button onclick="openCreateModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
        <i class="fas fa-plus mr-2"></i>New Video
    </button>
</div>

<!-- Videos Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="videos-grid">
    <div class="col-span-full flex justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-400"></div>
    </div>
</div>

<!-- Pagination -->
<div class="flex items-center justify-between mt-8">
    <div class="text-sm text-gray-400">
        Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="total-videos">0</span> videos
    </div>
    <div class="flex items-center space-x-2" id="pagination-controls">
        <!-- Pagination buttons will be inserted here -->
    </div>
</div>

<!-- Create/Edit Video Modal -->
<div id="video-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-white" id="modal-title">Create New Video</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="video-form" class="p-6 space-y-6">
                <input type="hidden" id="video-id">
                
                <!-- Title -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Title *</label>
                    <input type="text" id="video-title" required
                           class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                </div>
                
                <!-- Slug -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Slug</label>
                    <input type="text" id="video-slug"
                           class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                    <p class="text-xs text-gray-400 mt-1">Leave empty to auto-generate from title</p>
                </div>
                
                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                    <textarea id="video-description" rows="4"
                              class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3"></textarea>
                </div>
                
                <!-- Video Details Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Platform -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Platform *</label>
                        <select id="video-platform" required class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                            <option value="youtube">YouTube</option>
                            <option value="vimeo">Vimeo</option>
                            <option value="twitch">Twitch</option>
                            <option value="direct">Direct Upload</option>
                        </select>
                    </div>
                    
                    <!-- Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type</label>
                        <select id="video-type" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                            <option value="tutorial">Tutorial</option>
                            <option value="gameplay">Gameplay</option>
                            <option value="card_reveal">Card Reveal</option>
                            <option value="tournament">Tournament</option>
                            <option value="developer">Developer</option>
                            <option value="community">Community</option>
                        </select>
                    </div>
                </div>
                
                <!-- Video URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Video URL *</label>
                    <input type="url" id="video-url" required
                           class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3"
                           placeholder="https://www.youtube.com/watch?v=...">
                </div>
                
                <!-- Media Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Thumbnail -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Thumbnail URL</label>
                        <input type="url" id="video-thumbnail"
                               class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                    </div>
                    
                    <!-- Duration -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Duration (seconds)</label>
                        <input type="number" id="video-duration" min="0"
                               class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                    </div>
                </div>
                
                <!-- Embed Code -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Embed Code (Optional)</label>
                    <textarea id="video-embed" rows="3"
                              class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3"
                              placeholder="<iframe src=..."></textarea>
                </div>
                
                <!-- Status and Flags -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                        <select id="video-status" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    
                    <!-- Flags -->
                    <div class="flex items-center space-x-6 pt-8">
                        <label class="flex items-center">
                            <input type="checkbox" id="video-featured" class="rounded bg-gray-700 border-gray-600 text-purple-600">
                            <span class="ml-2 text-sm text-gray-300">Featured</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="video-trending" class="rounded bg-gray-700 border-gray-600 text-purple-600">
                            <span class="ml-2 text-sm text-gray-300">Trending</span>
                        </label>
                    </div>
                </div>
                
                <!-- Tags -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Tags</label>
                    <input type="text" id="video-tags" placeholder="tutorial, beginner, guide"
                           class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                    <p class="text-xs text-gray-400 mt-1">Separate tags with commas</p>
                </div>
                
                <!-- SEO -->
                <div class="border-t border-gray-700 pt-6">
                    <h4 class="text-lg font-medium text-white mb-4">SEO Settings</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Meta Title</label>
                            <input type="text" id="video-meta-title"
                                   class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Meta Description</label>
                            <textarea id="video-meta-description" rows="2"
                                      class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center justify-end space-x-4 border-t border-gray-700 pt-6">
                    <button type="button" onclick="closeModal()" 
                            class="px-6 py-3 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Video
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', function() {
    loadVideos();
    
    // Filter event listeners
    document.getElementById('status-filter').addEventListener('change', applyFilters);
    document.getElementById('type-filter').addEventListener('change', applyFilters);
    document.getElementById('platform-filter').addEventListener('change', applyFilters);
    document.getElementById('search-input').addEventListener('input', debounce(applyFilters, 500));
    
    // Form submission
    document.getElementById('video-form').addEventListener('submit', handleSubmit);
});

function applyFilters() {
    currentFilters = {
        status: document.getElementById('status-filter').value,
        type: document.getElementById('type-filter').value,
        platform: document.getElementById('platform-filter').value,
        search: document.getElementById('search-input').value
    };
    currentPage = 1;
    loadVideos();
}

async function loadVideos() {
    try {
        const params = new URLSearchParams({
            page: currentPage,
            page_size: 20,
            ...currentFilters
        });
        
        const response = await fetch(`/v1/admin/cms/videos?${params}`, {
            headers: {
                'Authorization': 'Bearer ' + getAdminToken()
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            renderVideosGrid(data.videos);
            renderPagination(data);
        } else {
            throw new Error('Failed to load videos');
        }
    } catch (error) {
        console.error('Error loading videos:', error);
        document.getElementById('videos-grid').innerHTML = `
            <div class="col-span-full text-center py-12 text-red-400">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i><br>
                Failed to load videos
            </div>
        `;
    }
}

function renderVideosGrid(videos) {
    const grid = document.getElementById('videos-grid');
    
    if (videos.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12 text-gray-400">
                <i class="fas fa-play-circle text-6xl mb-4"></i><br>
                <h3 class="text-xl font-medium mb-2">No videos found</h3>
                <p>Create your first video to get started</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = videos.map(video => {
        const statusColors = {
            published: 'bg-green-600',
            draft: 'bg-yellow-600',
            archived: 'bg-gray-600'
        };
        
        const platformIcons = {
            youtube: 'fab fa-youtube text-red-400',
            vimeo: 'fab fa-vimeo text-blue-400',
            twitch: 'fab fa-twitch text-purple-400',
            direct: 'fas fa-video text-gray-400'
        };
        
        const publishedDate = video.published_at ? 
            new Date(video.published_at).toLocaleDateString() : 'Not published';
            
        return `
            <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden hover:border-purple-500 transition-colors">
                <!-- Thumbnail -->
                <div class="relative aspect-video bg-gray-700">
                    ${video.thumbnail_url ? 
                        `<img src="${video.thumbnail_url}" alt="${video.title}" class="w-full h-full object-cover">` :
                        `<div class="w-full h-full flex items-center justify-center">
                            <i class="fas fa-play-circle text-4xl text-gray-500"></i>
                        </div>`
                    }
                    
                    <!-- Overlay badges -->
                    <div class="absolute top-2 left-2 flex items-center space-x-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium text-white ${statusColors[video.status]}">
                            ${video.status}
                        </span>
                        ${video.is_featured ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-600 text-white"><i class="fas fa-star mr-1"></i>Featured</span>' : ''}
                    </div>
                    
                    <!-- Duration -->
                    ${video.duration_formatted ? 
                        `<div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
                            ${video.duration_formatted}
                        </div>` : ''
                    }
                    
                    <!-- Platform icon -->
                    <div class="absolute bottom-2 left-2">
                        <i class="${platformIcons[video.platform] || 'fas fa-video text-gray-400'} text-lg"></i>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-4">
                    <h3 class="font-medium text-white mb-2 line-clamp-2">${video.title}</h3>
                    <p class="text-sm text-gray-400 mb-3 line-clamp-2">${video.description || 'No description'}</p>
                    
                    <!-- Stats -->
                    <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                        <span><i class="fas fa-eye mr-1"></i>${video.view_count}</span>
                        <span>${publishedDate}</span>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400 capitalize">${video.video_type.replace('_', ' ')}</span>
                        <div class="flex items-center space-x-2">
                            <button onclick="editVideo(${video.id})" class="text-purple-400 hover:text-purple-300">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="/videos/${video.slug}" target="_blank" class="text-green-400 hover:text-green-300">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button onclick="deleteVideo(${video.id})" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderPagination(data) {
    document.getElementById('showing-start').textContent = ((data.page - 1) * data.page_size) + 1;
    document.getElementById('showing-end').textContent = Math.min(data.page * data.page_size, data.total);
    document.getElementById('total-videos').textContent = data.total;
    
    const paginationControls = document.getElementById('pagination-controls');
    let html = '';
    
    // Previous button
    if (data.page > 1) {
        html += `<button onclick="changePage(${data.page - 1})" class="px-3 py-2 text-sm bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600">Previous</button>`;
    }
    
    // Page numbers
    for (let i = Math.max(1, data.page - 2); i <= Math.min(data.total_pages, data.page + 2); i++) {
        const isActive = i === data.page;
        html += `<button onclick="changePage(${i})" class="px-3 py-2 text-sm rounded-lg ${isActive ? 'bg-purple-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">${i}</button>`;
    }
    
    // Next button
    if (data.page < data.total_pages) {
        html += `<button onclick="changePage(${data.page + 1})" class="px-3 py-2 text-sm bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600">Next</button>`;
    }
    
    paginationControls.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    loadVideos();
}

function openCreateModal() {
    document.getElementById('modal-title').textContent = 'Create New Video';
    document.getElementById('video-form').reset();
    document.getElementById('video-id').value = '';
    document.getElementById('video-modal').classList.remove('hidden');
}

async function editVideo(id) {
    try {
        const response = await fetch(`/v1/admin/cms/videos/${id}`, {
            headers: {
                'Authorization': 'Bearer ' + getAdminToken()
            }
        });
        
        if (response.ok) {
            const video = await response.json();
            
            document.getElementById('modal-title').textContent = 'Edit Video';
            document.getElementById('video-id').value = video.id;
            document.getElementById('video-title').value = video.title;
            document.getElementById('video-slug').value = video.slug;
            document.getElementById('video-description').value = video.description || '';
            document.getElementById('video-platform').value = video.platform;
            document.getElementById('video-type').value = video.video_type;
            document.getElementById('video-url').value = video.video_url;
            document.getElementById('video-thumbnail').value = video.thumbnail_url || '';
            document.getElementById('video-duration').value = video.duration_seconds || '';
            document.getElementById('video-embed').value = video.embed_code || '';
            document.getElementById('video-status').value = video.status;
            document.getElementById('video-featured').checked = video.is_featured;
            document.getElementById('video-trending').checked = video.is_trending;
            document.getElementById('video-tags').value = (video.tags || []).join(', ');
            document.getElementById('video-meta-title').value = video.meta_title || '';
            document.getElementById('video-meta-description').value = video.meta_description || '';
            
            document.getElementById('video-modal').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading video:', error);
        alert('Failed to load video');
    }
}

async function handleSubmit(e) {
    e.preventDefault();
    
    const id = document.getElementById('video-id').value;
    const isEdit = !!id;
    
    const data = {
        title: document.getElementById('video-title').value,
        slug: document.getElementById('video-slug').value,
        description: document.getElementById('video-description').value,
        platform: document.getElementById('video-platform').value,
        video_type: document.getElementById('video-type').value,
        video_url: document.getElementById('video-url').value,
        thumbnail_url: document.getElementById('video-thumbnail').value,
        duration_seconds: parseInt(document.getElementById('video-duration').value) || null,
        embed_code: document.getElementById('video-embed').value,
        status: document.getElementById('video-status').value,
        is_featured: document.getElementById('video-featured').checked,
        is_trending: document.getElementById('video-trending').checked,
        tags: document.getElementById('video-tags').value.split(',').map(t => t.trim()).filter(t => t),
        meta_title: document.getElementById('video-meta-title').value,
        meta_description: document.getElementById('video-meta-description').value
    };
    
    try {
        const url = isEdit ? `/v1/admin/cms/videos/${id}` : '/v1/admin/cms/videos';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getAdminToken()
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeModal();
            loadVideos();
            alert(isEdit ? 'Video updated successfully!' : 'Video created successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to save video'));
        }
    } catch (error) {
        console.error('Error saving video:', error);
        alert('Failed to save video');
    }
}

async function deleteVideo(id) {
    if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/v1/admin/cms/videos/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + getAdminToken()
            }
        });
        
        if (response.ok) {
            loadVideos();
            alert('Video deleted successfully!');
        } else {
            alert('Failed to delete video');
        }
    } catch (error) {
        console.error('Error deleting video:', error);
        alert('Failed to delete video');
    }
}

function closeModal() {
    document.getElementById('video-modal').classList.add('hidden');
}

function getAdminToken() {
    return getCookie('admin_jwt') || localStorage.getItem('admin_token') || '';
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
